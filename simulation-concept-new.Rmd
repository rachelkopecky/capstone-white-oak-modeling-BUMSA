---
title: "Simulation Concept"
output:
  html_document:
    df_print: paged
---

```{r echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.width = 9)

library(tidyverse)
library(ggplot2)
library(readr)
library(tibbletime)
library(corrplot)
library(utf8)
library(stringr)
library(lmtest)
library(car)
library(gvlma)
library(sandwich)
library(forecast)
```

```{r echo = FALSE}
inv23 <- read_csv("WhiteOakData/white_oak_inv_23.csv")
inv24 <- read_csv("WhiteOakData/white_oak_inv_24.csv")
inv33 <- read_csv("WhiteOakData/white_oak_inv_33.csv")

inventory <- rbind(inv23, inv24, inv33)

inventory[is.na(inventory)] <- 0

inventory$UNIT <- paste0(inventory$STATECD, "0", inventory$UNITCD)

oak <- read_csv("WhiteOakData/white-oak-clean.csv")
oak[is.na(oak)] <- 0

oak_merge <- oak %>%
  group_by(STATE_ABBR, EVAL_GRP_YEAR, UNIT) %>%
  summarise(total_removal = sum(SELECT_WHITE_OAK_REMOVAL, na.rm = TRUE),
            total_growth = sum(SELECT_WHITE_OAK_GROWTH, na.rm = TRUE),
            total_mortality = sum(SELECT_WHITE_OAK_MORTALITY, na.rm = TRUE)) %>%
  mutate(total_growth_true = total_growth + total_mortality)

oak_merge$total_growth <- NULL
colnames(oak_merge)[6] <- "total_growth"

inventory_merge <- inventory %>%
  group_by(STATE_ABBR, EVAL_GRP_YEAR, UNIT) %>%
  summarise(total_inventory = sum(SELECT_WHITE_OAK_INV_CUFT_GS, na.rm = TRUE),
            total_hardwood = sum(TOTAL_HARDWOOD_INV_CUFT_GS, na.rm = TRUE))

oak_total <- merge(oak_merge, inventory_merge, by = c("STATE_ABBR", "EVAL_GRP_YEAR", "UNIT"))

fire <- read_csv("fire_data.csv")
colnames(fire) <- c("STATE_ABBR", "num_fires", "acres_burned", "EVAL_GRP_YEAR")

mod.dat <- oak_total %>%
  group_by(STATE_ABBR, EVAL_GRP_YEAR) %>%
  summarise(total_removal = sum(total_removal),
            total_growth = sum(total_growth),
            total_mortality = sum(total_mortality),
            total_inventory = sum(total_inventory),
            total_hardwood = sum(total_hardwood))

r9 <- c("MN", "IA", "MO", "WI", "IL", "MI", "IN", "OH", "WV", "PA", "NJ", "DE", "MD", "NY", "CT", "RI", "MA", "VT", "NH", "ME")

r2 <- c("ND", "SD", "NE", "KS")

r8 <- c("TX", "OK", "LA", "AR", "MS", "AL", "GA", "FL", "TN", "KY", "VA", "NC", "SC")

mod.dat$region <- ifelse(mod.dat$STATE_ABBR %in% r9, "R9",
                         ifelse(mod.dat$STATE_ABBR %in% r8, "R8",
                                ifelse(mod.dat$STATE_ABBR %in% r2, "R2", "NA")))

write_csv(mod.dat, "mod_dat_final.csv")


pdsi_states <- read_csv("pdsi_states.csv")

pest_output <- read_csv("pest_output.csv")
pest_merge <- merge(pest_output, pdsi_states, by = "State")
colnames(pest_merge)[5] <- "STATE_ABBR"
pest_merge$region <- ifelse(pest_merge$STATE_ABBR %in% r9, "R9",
                         ifelse(pest_merge$STATE_ABBR %in% r8, "R8",
                                ifelse(pest_merge$STATE_ABBR %in% r2, "R2", "NA")))

state_land_area <- read_csv("state_land_area.csv")

state_land_area <- separate(data = state_land_area, col = `State`, into = c("State", "Other"), sep = " flag")
state_land_area <- separate(data = state_land_area, col = `Land Area (sq mi)`, into = c("land_area", "other"), sep = "\\.")
state_land_area <- state_land_area %>%
  select(State, land_area)

state_land_area$land_area <- gsub(",", "", state_land_area$land_area)
state_land_area$land_area2 <- as.numeric(state_land_area$land_area)
state_land_area$land_area <- state_land_area$land_area2
state_land_area$land_area2 <- NULL

state_land_area_merge <- merge(state_land_area, pdsi_states, by = c("State")) %>%
  mutate(land_area_acres = land_area*640)

state_land_area_merge$land_area <- NULL
state_land_area_merge$State <- NULL

colnames(state_land_area_merge) <- c("STATE_ABBR", "land_area_acres")

r9 <- c("MN", "IA", "MO", "WI", "IL", "MI", "IN", "OH", "WV", "PA", "NJ", "DE", "MD", "NY", "CT", "RI", "MA", "VT", "NH", "ME")

r2 <- c("ND", "SD", "NE", "KS")

r8 <- c("TX", "OK", "LA", "AR", "MS", "AL", "GA", "FL", "TN", "KY", "VA", "NC", "SC")

state_land_area_merge$region <- ifelse(state_land_area_merge$STATE_ABBR %in% r9, "R9",
                         ifelse(state_land_area_merge$STATE_ABBR %in% r8, "R8",
                                ifelse(state_land_area_merge$STATE_ABBR %in% r2, "R2", "NA")))

state_land_area_reg <- state_land_area_merge %>%
  group_by(region) %>%
  summarise(land_area_acres = sum(land_area_acres))

```

```{r echo = FALSE}

# catastrophic_fires <- read_csv("catastrophic_fires.csv")
# 
# catastrophic_fires <- mutate(catastrophic_fires,
#                              cu_ft_burned = acres_burned*43560)
# 
# state_land_area <- read_csv("state_land_area.csv")
# 
# state_land_area <- separate(data = state_land_area, col = `State`, into = c("State", "Other"), sep = " flag")
# state_land_area <- separate(data = state_land_area, col = `Land Area (sq mi)`, into = c("land_area", "other"), sep = "\\.")
# state_land_area <- state_land_area %>%
#   select(State, land_area)
# 
# state_land_area$land_area <- gsub(",", "", state_land_area$land_area)
# state_land_area$land_area2 <- as.numeric(state_land_area$land_area)
# state_land_area$land_area <- state_land_area$land_area2
# state_land_area$land_area2 <- NULL
# 

# 
# state_land_area_merge <- merge(state_land_area, pdsi_states, by = c("State")) %>%
#   mutate(land_area_acres = land_area*640)
# 
# state_land_area_merge$land_area <- NULL
# state_land_area_merge$State <- NULL
# 
# colnames(state_land_area_merge) <- c("STATE_ABBR", "land_area_acres")
# 
# r9 <- c("MN", "IA", "MO", "WI", "IL", "MI", "IN", "OH", "WV", "PA", "NJ", "DE", "MD", "NY", "CT", "RI", "MA", "VT", "NH", "ME")
# 
# r2 <- c("ND", "SD", "NE", "KS")
# 
# r8 <- c("TX", "OK", "LA", "AR", "MS", "AL", "GA", "FL", "TN", "KY", "VA", "NC", "SC")
# 
# state_land_area_merge$region <- ifelse(state_land_area_merge$STATE_ABBR %in% r9, "R9",
#                          ifelse(state_land_area_merge$STATE_ABBR %in% r8, "R8",
#                                 ifelse(state_land_area_merge$STATE_ABBR %in% r2, "R2", "NA")))
# 
# catastrophic_fires$region <- ifelse(catastrophic_fires$STATE_ABBR %in% r9, "R9",
#                          ifelse(catastrophic_fires$STATE_ABBR %in% r8, "R8",
#                                 ifelse(catastrophic_fires$STATE_ABBR %in% r2, "R2", "NA")))
# 
# state_land_area_reg <- state_land_area_merge %>%
#   group_by(region) %>%
#   summarise(land_area_acres = sum(land_area_acres))
# 
# catastrophic_fires <- catastrophic_fires %>%
#   filter(region != "NA",
#          EVAL_GRP_YEAR <= 2014) %>%
#   merge(., state_land_area_reg, by = "region")
# 
# catastrophic_fires <- mutate(catastrophic_fires,
#                              pct_area_burned = (acres_burned / land_area_acres))

# mod.dat$region <- ifelse(mod.dat$STATE_ABBR %in% r9, "R9",
#                          ifelse(mod.dat$STATE_ABBR %in% r8, "R8",
#                                 ifelse(mod.dat$STATE_ABBR %in% r2, "R2", "NA")))



pest_merge <- read_csv("pest_final.csv")

pest_r8 <- pest_merge %>% 
  filter(region == "R8") %>% 
  group_by(Year) %>% 
  summarise(total_acres = sum(Acres))

pest_r9 <- pest_merge %>% 
  filter(region == "R9") %>% 
  group_by(Year) %>% 
  summarise(total_acres = sum(Acres))

pest_r2 <- pest_merge %>% 
  filter(region == "R2") %>% 
  group_by(Year) %>% 
  summarise(total_acres = sum(Acres))


# How many times was the pest volume in each region greater than the region's average? (a potential way to quatify the  more rare outbreaks)

pest_r9$outbreak <- ifelse(pest_r9$total_acres > mean(pest_r9$total_acres), 1, 0)
pest_r8$outbreak <- ifelse(pest_r8$total_acres > mean(pest_r8$total_acres), 1, 0)
pest_r2$outbreak <- ifelse(pest_r2$total_acres > mean(pest_r2$total_acres), 1, 0)

pest_inv <- mod.dat %>% 
  filter(EVAL_GRP_YEAR == 2014) %>% 
  group_by(EVAL_GRP_YEAR, region) %>% 
  summarise(total_hardwood = sum(total_hardwood, na.rm = TRUE))

pest_r2$reg_acres <- state_land_area_reg$land_area_acres[state_land_area_reg$region == "R2"]
pest_r9$reg_acres <- state_land_area_reg$land_area_acres[state_land_area_reg$region == "R9"]
pest_r8$reg_acres <- state_land_area_reg$land_area_acres[state_land_area_reg$region == "R8"]

pest_r2$pct_acres <- pest_r2$total_acres/pest_r2$reg_acres
pest_r9$pct_acres <- pest_r9$total_acres/pest_r9$reg_acres
pest_r8$pct_acres <- pest_r8$total_acres/pest_r8$reg_acres

# How often was the state/region in severe drought? 

drought_monitor <- read_csv("drought_monitor.csv")
drought_monitor$year <- str_sub(drought_monitor$ReleaseDate, 1, 4)
colnames(drought_monitor)[2] <- "STATE_ABBR"


drought_monitor$region <- ifelse(drought_monitor$STATE_ABBR %in% r9, "R9",
                         ifelse(drought_monitor$STATE_ABBR %in% r8, "R8",
                                ifelse(drought_monitor$STATE_ABBR %in% r2, "R2", "NA")))

drought_monitor_reg <- drought_monitor %>%
  group_by(region, year) %>%
  filter(region != "NA") %>%
  summarise(total_d4 = sum(as.numeric(D4), na.rm = TRUE),
            total_d3 = sum(as.numeric(D3), na.rm = TRUE))

tornado_dat <- read_csv("Tornado/Consolidated_Tornados_50_16.csv")

colnames(tornado_dat)[2] <- "STATE_ABBR"
tornado_dat$region <- ifelse(tornado_dat$STATE_ABBR %in% r9, "R9",
                         ifelse(tornado_dat$STATE_ABBR %in% r8, "R8",
                                ifelse(tornado_dat$STATE_ABBR %in% r2, "R2", "NA")))

tornado_dat_5 <- tornado_dat %>% 
  filter(magnitude == 5) %>% 
  group_by(region, year) %>% 
  summarise(acres_destroyed = sum(acres))

tornado_2 <- tornado_dat_5 %>% 
  filter(region == "R2") %>% 
  mutate(region_acres = state_land_area_reg$land_area_acres[state_land_area_reg$region == "R2"],
         pct_acres = acres_destroyed/region_acres)

tornado_9 <- tornado_dat_5 %>% 
  filter(region == "R9") %>% 
  mutate(region_acres = state_land_area_reg$land_area_acres[state_land_area_reg$region == "R9"],
         pct_acres = acres_destroyed/region_acres)

tornado_8 <- tornado_dat_5 %>% 
  filter(region == "R8") %>% 
  mutate(region_acres = state_land_area_reg$land_area_acres[state_land_area_reg$region == "R8"],
         pct_acres = acres_destroyed/region_acres)

#mod.dat <- read_csv("mod_dat_final.csv")
#catastrophic_fires <- read_csv("cat_fires_final.csv")

more_fire <- read_csv("more_fire_final.csv")

fire_inv <- mod.dat  %>% 
  filter(EVAL_GRP_YEAR == 2014) %>% 
  group_by(EVAL_GRP_YEAR, region) %>% 
  summarise(total_inv = sum(total_inventory, na.rm = TRUE))

fire_r8_df <- more_fire %>% 
  filter(region == "R8") %>% 
  group_by(FIRE_YEAR) %>% 
  summarise(total_acres = sum(tot_acres))

fire_r9_df <- more_fire %>% 
  filter(region == "R9") %>% 
  group_by(FIRE_YEAR) %>% 
  summarise(total_acres = sum(tot_acres))

fire_r2_df <- more_fire %>% 
  filter(region == "R2") %>% 
  group_by(FIRE_YEAR) %>% 
  summarise(total_acres = sum(tot_acres))

fire_r2_df$reg_acres <- fire_inv$total_inv[fire_inv$region == "R2"]
fire_r9_df$reg_acres <- fire_inv$total_inv[fire_inv$region == "R9"]
fire_r8_df$reg_acres <- fire_inv$total_inv[fire_inv$region == "R8"]

fire_r2_df$pct_acres <- fire_r2_df$total_acres/fire_r2_df$reg_acres
fire_r9_df$pct_acres <- fire_r9_df$total_acres/fire_r9_df$reg_acres
fire_r8_df$pct_acres <- fire_r8_df$total_acres/fire_r8_df$reg_acres

## Urbanized land 2050

pct_urban <- read_csv("percent-forestland-urban.csv")

# weight by state percent of WO in region

region_weights <- mod.dat %>% 
  filter(EVAL_GRP_YEAR == 2014) %>% 
  group_by(STATE_ABBR, region) %>% 
  summarise(total_inventory = sum(total_inventory))

region_weights$region_total <- ifelse(region_weights$region == "R9", sum(region_weights$total_inventory[region_weights$region == "R9"]), ifelse(region_weights$region == "R8", sum(region_weights$total_inventory[region_weights$region == "R8"]), sum(region_weights$total_inventory[region_weights$region == "R2"])))

region_weights$WO_pct_region <- region_weights$total_inventory/region_weights$region_total

colnames(pct_urban)[1] <- "STATE_ABBR"

pct_urban_final <- merge(pct_urban, region_weights, by = "STATE_ABBR") %>% 
  mutate(mult_weight = pct_forestland_urban_2050 * WO_pct_region) %>% 
  group_by(region) %>% 
  summarise(weight_sum = sum(WO_pct_region),
            weighted_pct = sum(mult_weight)) %>% 
  mutate(weighted_avg = weighted_pct / weight_sum)




mod.dat.r9 <- mod.dat %>% 
  filter(region == "R9") %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_inventory = sum(total_inventory),
            total_mortality = sum(total_mortality),
            total_removal = sum(as.numeric(total_removal)),
            total_growth = sum(as.numeric(total_growth)))

mod.dat.r8 <- mod.dat %>% 
  filter(region == "R8") %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_inventory = sum(total_inventory),
            total_mortality = sum(total_mortality),
            total_removal = sum(as.numeric(total_removal)),
            total_growth = sum(as.numeric(total_growth)))

mod.dat.r2 <- mod.dat %>% 
  filter(region == "R2") %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_inventory = sum(total_inventory),
            total_mortality = sum(total_mortality),
            total_removal = sum(as.numeric(total_removal)),
            total_growth = sum(as.numeric(total_growth)))


```

In the simulation outline below, we sample from a normal distribution with a mean equal to the coefficient of a linear model and a standard deviation equal to the standard error on the coefficient estimate in order to obtain rate of change values the growth, removal, and mortality percent of inventory. We then calculate the new percent of inventory each year by multiplying the number of years elapsed by the rate of chance (ROC) and add an intercept (calculated by taking the mean of the last 5 years of data). We also include a yearly shock value to provide a simple example of how we can incorporate the outside variables like wildfire, pests, drought, etc. The initial inventory value is the true inventory in the year 2014, and each subsequent year is calculated by adding/subtracting the growth, removal, mortality, and yearly shock values.

```{r}

# Calculate growth, removal, mortality percent of inventory
mod.dat.r9 <- mod.dat.r9 %>% 
  mutate(growth.pct = total_growth/total_inventory,
         remv.pct = total_removal/total_inventory, 
         mort.pct = total_mortality/total_inventory)

mod.dat.r8 <- mod.dat.r8 %>% 
  mutate(growth.pct = total_growth/total_inventory,
         remv.pct = total_removal/total_inventory, 
         mort.pct = total_mortality/total_inventory)

mod.dat.r2 <- mod.dat.r2 %>% 
  mutate(growth.pct = total_growth/total_inventory,
         remv.pct = total_removal/total_inventory, 
         mort.pct = total_mortality/total_inventory)

# Filter to 2002 to 2014 for consistency in measurement method

mod.dat.r9 <- filter(mod.dat.r9, EVAL_GRP_YEAR >= 2002 & EVAL_GRP_YEAR <= 2014)
mod.dat.r8 <- filter(mod.dat.r8, EVAL_GRP_YEAR >= 2002 & EVAL_GRP_YEAR <= 2014)
mod.dat.r2 <- filter(mod.dat.r2, EVAL_GRP_YEAR >= 2002 & EVAL_GRP_YEAR <= 2014)

# Build linear models for each and save summary stats
growth.mod.r9 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r9)
growth.summary.r9 <- summary(growth.mod.r9)
mort.mod.r9 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r9)
mort.summary.r9 <- summary(mort.mod.r9)
remv.mod.r9 <- lm(remv.pct ~ EVAL_GRP_YEAR, data = mod.dat.r9)
remv.summary.r9 <- summary(remv.mod.r9)

growth.mod.r8 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r8)
growth.summary.r8 <- summary(growth.mod.r8)
mort.mod.r8 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r8)
mort.summary.r8 <- summary(mort.mod.r8)
remv.mod.r8 <- lm(remv.pct ~ EVAL_GRP_YEAR, data = mod.dat.r8)
remv.summary.r8 <- summary(remv.mod.r8)

growth.mod.r2 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
growth.summary.r2 <- summary(growth.mod.r2)
mort.mod.r2 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
mort.summary.r2 <- summary(mort.mod.r2)
remv.mod.r2 <- lm(remv.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
remv.summary.r2 <- summary(remv.mod.r2)

# Check Assumptions

# Independence of Errors (Autocorrelation)

# Breusch Godfrey test
bgtest(remv.mod.r2) # fail to reject
bgtest(remv.mod.r9) # fail to reject
bgtest(remv.mod.r8) # fail to reject
bgtest(mort.mod.r2) # fail to reject
bgtest(mort.mod.r9) # fail to reject
bgtest(mort.mod.r8) # fail to reject
bgtest(growth.mod.r2) # fail to reject
bgtest(growth.mod.r9) # fail to reject
bgtest(growth.mod.r8) # fail to reject

# Ljung Box Test
Box.test(remv.mod.r2$residuals, type="Ljung-Box") # fail to reject
Box.test(remv.mod.r9$residuals, type="Ljung-Box") # fail to reject
Box.test(remv.mod.r8$residuals, type="Ljung-Box") # fail to reject
Box.test(mort.mod.r2$residuals, type="Ljung-Box") # fail to reject
Box.test(mort.mod.r9$residuals, type="Ljung-Box") # fail to reject
Box.test(mort.mod.r8$residuals, type="Ljung-Box") # fail to reject
Box.test(growth.mod.r2$residuals, type="Ljung-Box") # fail to reject
Box.test(growth.mod.r9$residuals, type="Ljung-Box") # fail to reject
Box.test(growth.mod.r8$residuals, type="Ljung-Box") # fail to reject

# Heteroscedasticity

# Breusch Pagan test

bptest(growth.mod.r9) # fail to reject
bptest(growth.mod.r8) # fail to reject
bptest(growth.mod.r2) # fail to reject
bptest(mort.mod.r9) # fail to reject
bptest(mort.mod.r8) # fail to reject
bptest(mort.mod.r2) # fail to reject 
bptest(remv.mod.r9) # fail to reject
bptest(remv.mod.r8) # reject the null
bptest(remv.mod.r2) # reject the null

# Normality
shapiro.test(growth.mod.r9$residuals) # fail to reject
shapiro.test(growth.mod.r8$residuals) # fail to reject
shapiro.test(growth.mod.r2$residuals) # fail to reject
shapiro.test(mort.mod.r9$residuals) # fail to reject
shapiro.test(mort.mod.r8$residuals) # fail to reject
shapiro.test(mort.mod.r2$residuals) # fail to reject 
shapiro.test(remv.mod.r9$residuals) # fail to reject
shapiro.test(remv.mod.r8$residuals) # fail to reject
shapiro.test(remv.mod.r2$residuals) # fail to reject

# Mean of errors is 0
mean(growth.mod.r9$residuals) # true
mean(growth.mod.r8$residuals) # true
mean(growth.mod.r2$residuals) # true
mean(mort.mod.r9$residuals) # true
mean(mort.mod.r8$residuals) # true
mean(mort.mod.r2$residuals) # true
mean(remv.mod.r9$residuals) # true
mean(remv.mod.r8$residuals) # true
mean(remv.mod.r2$residuals) # true

# Check Residuals




# Fix heteroscedasticity problems
remv.mod.r8$newse <- vcovHC(remv.mod.r8, type="HC3")
remv.summary.r8 <- coeftest(remv.mod.r8, remv.mod.r8$newse)
remv.mod.r2$newse <- vcovHC(remv.mod.r2, type="HC3")
remv.summary.r2 <- coeftest(remv.mod.r2, remv.mod.r2$newse)

```

```{r}

years <- 2014:2064

# Build simulation function
run_sim <- function() {
  # Define forecast period
  inv <- 0
  df <- tibble(year = years, inventory.r9 = inv, inventory.r8 = inv, inventory.r2 = inv, total_inventory = inv, new_growth_pct_r9 = inv, new_growth_pct_r8 = inv, new_remv_pct_r8 = inv, new_mort_pct_r2 = inv, new_mort_pct_r8 = inv)
  
  # Initial inventory equal to 2014 inventory
  df$inventory.r9[df$year == 2014] <- mod.dat.r9$total_inventory[nrow(mod.dat.r9)]
  df$inventory.r8[df$year == 2014] <- mod.dat.r8$total_inventory[nrow(mod.dat.r8)]
  df$inventory.r2[df$year == 2014] <- mod.dat.r2$total_inventory[nrow(mod.dat.r2)]
  
  df$new_growth_pct_r8[df$year == 2014] <- mod.dat.r8$growth.pct[nrow(mod.dat.r8)]
  df$new_growth_pct_r9[df$year == 2014] <- mod.dat.r9$growth.pct[nrow(mod.dat.r9)]
  df$new_mort_pct_r8[df$year == 2014] <- mod.dat.r8$mort.pct[nrow(mod.dat.r8)]
  df$new_mort_pct_r2[df$year == 2014] <- mod.dat.r2$mort.pct[nrow(mod.dat.r2)]
  df$new_remv_pct_r8[df$year == 2014] <- mod.dat.r8$remv.pct[nrow(mod.dat.r8)]
  
  # Build the normal distributions for growth, mortality, removal
  growth_dist_r9 <- rnorm(100, growth.mod.r9$coefficients[[2]], growth.summary.r9$coefficients[[4]])
  mortality_dist_r9 <- rnorm(100, mort.mod.r9$coefficients[[2]], mort.summary.r9$coefficients[[4]])
  removal_dist_r9 <- rnorm(100, remv.mod.r9$coefficients[[2]], remv.summary.r9$coefficients[[4]])
  
  growth_dist_r8 <- rnorm(100, growth.mod.r8$coefficients[[2]], growth.summary.r8$coefficients[[4]])
  mortality_dist_r8 <- rnorm(100, mort.mod.r8$coefficients[[2]], mort.summary.r8$coefficients[[4]])
  removal_dist_r8 <- rnorm(100, remv.mod.r8$coefficients[[2]], remv.summary.r8[[4]])

  growth_dist_r2 <- rnorm(100, growth.mod.r2$coefficients[[2]], growth.summary.r2$coefficients[[4]])
  mortality_dist_r2 <- rnorm(100, mort.mod.r2$coefficients[[2]], mort.summary.r2$coefficients[[4]])
  removal_dist_r2 <- rnorm(100, remv.mod.r2$coefficients[[2]], remv.summary.r2[[4]])
  
  # Build additional distributions for the models containing lagged variables
  # removal_lag_dist_r8 <- rnorm(100, remv.mod.r8$coefficients[[3]], remv.summary.r8[[6]])
  # mortality_lag_dist_r8 <- rnorm(100, mort.mod.r8$coefficients[[3]], mort.summary.r8$coefficients[[6]])
  # mortality_lag_dist_r2 <- rnorm(100, mort.mod.r2$coefficients[[3]], mort.summary.r2$coefficients[[6]])
  # growth_lag_dist_r8 <- rnorm(100, growth.mod.r8$coefficients[[3]], growth.summary.r8$coefficients[[6]])
  # growth_lag_dist_r9 <- rnorm(100, growth.mod.r9$coefficients[[3]], growth.summary.r9[[6]])
  
  # Define rate of change by sampling from distributions created above. We want the rate of change to be the same over the entire forecasted time period, but different for each simulation. This is why we define it prior to the while loop below.
  growth_roc_r9 <- base::sample(growth_dist_r9, 1)
  mortality_roc_r9 <- base::sample(mortality_dist_r9, 1)
  removal_roc_r9 <- base::sample(removal_dist_r9, 1)
  
  growth_roc_r8 <- base::sample(growth_dist_r8, 1)
  mortality_roc_r8 <- base::sample(mortality_dist_r8, 1)
  removal_roc_r8 <- base::sample(removal_dist_r8, 1)
  
  growth_roc_r2 <- base::sample(growth_dist_r2, 1)
  mortality_roc_r2 <- base::sample(mortality_dist_r2, 1)
  removal_roc_r2 <- base::sample(removal_dist_r2, 1)
  
  # growth_lag_roc_r8 <- growth.mod.r8$coefficients[[3]]
  # growth_lag_roc_r9 <- growth.mod.r9$coefficients[[3]]
  # mortality_lag_roc_r2 <- mort.mod.r2$coefficients[[3]]
  # mortality_lag_roc_r8 <- mort.mod.r8$coefficients[[3]]
  # removal_lag_roc_r8 <- remv.mod.r8$coefficients[[3]]
  
  # Define rate of change for lagged variables
  # growth_lag_roc_r9 <- base::sample(growth_lag_dist_r9, 1)
  # growth_lag_roc_r8 <- base::sample(growth_lag_dist_r8, 1)
  # mortality_lag_roc_r8 <- base::sample(mortality_lag_dist_r8, 1)
  # mortality_lag_roc_r2 <- base::sample(mortality_lag_dist_r2, 1)
  # removal_lag_roc_r8 <- base::sample(removal_lag_dist_r8, 1)
  
  y <- 2015
  
  # Define intercepts by taking the average of the last 5 years for growth, removal, mortality percent of inventory
  growth_int_r9 <- mean(mod.dat.r9$growth.pct[(nrow(mod.dat.r9)-5):nrow(mod.dat.r9)])
  mortality_int_r9 <- mean(mod.dat.r9$mort.pct[(nrow(mod.dat.r9)-5):nrow(mod.dat.r9)])
  removal_int_r9 <- mean(mod.dat.r9$remv.pct[(nrow(mod.dat.r9)-5):nrow(mod.dat.r9)])
  
  growth_int_r8 <- mean(mod.dat.r8$growth.pct[(nrow(mod.dat.r8)-5):nrow(mod.dat.r8)])
  mortality_int_r8 <- mean(mod.dat.r8$mort.pct[(nrow(mod.dat.r8)-5):nrow(mod.dat.r8)])
  removal_int_r8 <- mean(mod.dat.r8$remv.pct[(nrow(mod.dat.r8)-5):nrow(mod.dat.r8)])
  
  growth_int_r2 <- mean(mod.dat.r2$growth.pct[(nrow(mod.dat.r2)-5):nrow(mod.dat.r2)])
  mortality_int_r2 <- mean(mod.dat.r2$mort.pct[(nrow(mod.dat.r2)-5):nrow(mod.dat.r2)])
  removal_int_r2 <- mean(mod.dat.r2$remv.pct[(nrow(mod.dat.r2)-5):nrow(mod.dat.r2)])
  
  # Determine probability of catastrophic fire in each region
  
  fire_r8_prob <- nrow(fire_r8_df)/(2014-min(fire_r8_df$FIRE_YEAR))
  fire_r9_prob <- nrow(fire_r9_df)/(2014-min(fire_r9_df$FIRE_YEAR))
  fire_r2_prob <- nrow(fire_r2_df)/(2014-min(fire_r2_df$FIRE_YEAR))
  
  fire_density_r9 <- density(fire_r9_df$pct_acres)
  fire_density_r9 <- data.frame(fire_density_r9$x, fire_density_r9$y)
  colnames(fire_density_r9) <- c("x","y")
  fire_density_r9 <- filter(fire_density_r9, x >= 0)
  
  fire_density_r8 <- density(fire_r8_df$pct_acres)
  fire_density_r8 <- data.frame(fire_density_r8$x, fire_density_r8$y)
  colnames(fire_density_r8) <- c("x","y")
  fire_density_r8 <- filter(fire_density_r8, x >= 0)
  
  fire_density_r2 <- density(fire_r2_df$pct_acres)
  fire_density_r2 <- data.frame(fire_density_r2$x, fire_density_r2$y)
  colnames(fire_density_r2) <- c("x","y")
  fire_density_r2 <- filter(fire_density_r2, x >= 0)
  
  # Determine probability of larger than normal pest outbreak
  
  pest_r8_prob <- sum(pest_r8$outbreak)/(max(pest_r8$Year)-min(pest_r8$Year))
  pest_r9_prob <- sum(pest_r9$outbreak)/(max(pest_r9$Year)-min(pest_r9$Year))
  pest_r2_prob <- sum(pest_r2$outbreak)/(max(pest_r2$Year)-min(pest_r2$Year))
  
  pest_density_r2 <- density(pest_r2$pct_acres[pest_r2$outbreak==1])
  pest_density_r2 <- data.frame(pest_density_r2$x, pest_density_r2$y)
  colnames(pest_density_r2) <- c("x","y")
  pest_density_r2 <- filter(pest_density_r2, x >= 0)
  
  pest_density_r8 <- density(pest_r8$pct_acres[pest_r8$outbreak==1])
  pest_density_r8 <- data.frame(pest_density_r8$x, pest_density_r8$y)
  colnames(pest_density_r8) <- c("x","y")
  pest_density_r8 <- filter(pest_density_r8, x >= 0)
  
  pest_density_r9 <- density(pest_r9$pct_acres[pest_r9$outbreak==1])
  pest_density_r9 <- data.frame(pest_density_r9$x, pest_density_r9$y)
  colnames(pest_density_r9) <- c("x","y")
  pest_density_r9 <- filter(pest_density_r9, x >= 0)
  
    # Determine probability of category 5 tornado
  
  tornado_r8_prob <- nrow(tornado_8)/(max(tornado_8$year)-min(tornado_8$year))
  tornado_r9_prob <- nrow(tornado_9)/(max(tornado_9$year)-min(tornado_9$year))
  tornado_r2_prob <- nrow(tornado_2)/(max(tornado_2$year)-min(tornado_2$year))
  
  tornado_density_r2 <- density(tornado_2$pct_acres)
  tornado_density_r2 <- data.frame(tornado_density_r2$x, tornado_density_r2$y)
  colnames(tornado_density_r2) <- c("x","y")
  tornado_density_r2 <- filter(tornado_density_r2, x >= 0)
  
  tornado_density_r8 <- density(tornado_8$pct_acres)
  tornado_density_r8 <- data.frame(tornado_density_r8$x, tornado_density_r8$y)
  colnames(tornado_density_r8) <- c("x","y")
  tornado_density_r8 <- filter(tornado_density_r8, x >= 0)
  
  tornado_density_r9 <- density(tornado_9$pct_acres)
  tornado_density_r9 <- data.frame(tornado_density_r9$x, tornado_density_r9$y)
  colnames(tornado_density_r9) <- c("x","y")
  tornado_density_r9 <- filter(tornado_density_r9, x >= 0)
  
  
  # Use while loop to build forecast year by year
  while (y < 2065) {
    
    # Will there be a fire, and if yes, what will the effect be?
    
    fire_r9 <- sample(c(0,1),1,prob = c((1-fire_r9_prob),fire_r9_prob))
    fire_r8 <- sample(c(0,1),1,prob = c((1-fire_r8_prob),fire_r8_prob))
    fire_r2 <- sample(c(0,1),1,prob = c((1-fire_r2_prob),fire_r2_prob))
    
    if(fire_r9 == 1){
      fire_effect_r9 <- sample(fire_density_r9$x, 1, prob = fire_density_r9$y)
    } else {
      fire_effect_r9 <- 0
    }
    
    if(fire_r8 == 1){
      fire_effect_r8 <- sample(fire_density_r8$x, 1, prob = fire_density_r8$y)
    } else {
      fire_effect_r8 <- 0
    }
    
    if(fire_r2 == 1){
      fire_effect_r2 <- sample(fire_density_r2$x, 1, prob = fire_density_r2$y)
    } else {
      fire_effect_r2 <- 0
    }
    
    # Will there be a pest outbreak? And if yes, what will the effect be?
    
    pest_ob_r9 <- sample(c(0,1),1,prob = c((1-pest_r9_prob),pest_r9_prob))
    pest_ob_r8 <- sample(c(0,1),1,prob = c((1-pest_r8_prob),pest_r8_prob))
    pest_ob_r2 <- sample(c(0,1),1,prob = c((1-pest_r2_prob),pest_r2_prob))
    
    if(pest_ob_r9 == 1){
      pest_effect_r9 <- sample(pest_density_r9$x, 1, prob = pest_density_r9$y)
    } else {
      pest_effect_r9 <- 0
    }
    
    if(pest_ob_r2 == 1){
      pest_effect_r2 <- sample(pest_density_r2$x, 1, prob = pest_density_r2$y)
    } else {
      pest_effect_r2 <- 0
    }
    
    if(pest_ob_r8 == 1){
      pest_effect_r8 <- sample(pest_density_r8$x, 1, prob = pest_density_r8$y)
    } else {
      pest_effect_r8 <- 0
    }
    
    # Will there be a big tornado outbreak? And if yes, what will the effect be?
    
    tornado_r9 <- sample(c(0,1),1,prob = c((1-tornado_r9_prob),tornado_r9_prob))
    tornado_r8 <- sample(c(0,1),1,prob = c((1-tornado_r8_prob),tornado_r8_prob))
    tornado_r2 <- sample(c(0,1),1,prob = c((1-tornado_r2_prob),tornado_r2_prob))
    
    if(tornado_r9 == 1){
      tornado_effect_r9 <- sample(tornado_density_r9$x, 1, prob = tornado_density_r9$y)
    } else {
      tornado_effect_r9 <- 0
    }
    
    if(tornado_r2 == 1){
      tornado_effect_r2 <- sample(tornado_density_r2$x, 1, prob = tornado_density_r2$y)
    } else {
      tornado_effect_r2 <- 0
    }
    
    if(tornado_r8 == 1){
      tornado_effect_r8 <- sample(tornado_density_r8$x, 1, prob = tornado_density_r8$y)
    } else {
      tornado_effect_r8 <- 0
    }
    

    # Define starting inventory value
    start_inv_r9 <- df$inventory.r9[df$year == (y-1)]
    
    # Calculate the new growth, removal, mortality percent of inventory for the year
    df$new_growth_pct_r9[df$year == y] <- (y - 2014)*growth_roc_r9 + growth_int_r9 
    #+ df$new_growth_pct_r9[df$year == (y-1)]*growth_lag_roc_r9
    new_mort_pct_r9 <- (y - 2014)*mortality_roc_r9 + mortality_int_r9
    new_remv_pct_r9 <- (y - 2014)*removal_roc_r9 + removal_int_r9
    
    if(df$new_growth_pct_r9[df$year == y] < 0){
      df$new_growth_pct_r9[df$year == y] <- 0
    }
    if(new_mort_pct_r9 < 0){
      new_mort_pct_r9 <- 0
    }
    if(new_remv_pct_r9 < 0){
      new_remv_pct_r9 <- 0
    }
    
    # Calculate the inventory value for the year
    df$inventory.r9[df$year == y] <- start_inv_r9[[1]] + 
    df$new_growth_pct_r9[df$year == y] * start_inv_r9[[1]] - 
    new_mort_pct_r9 * start_inv_r9[[1]] - 
    new_remv_pct_r9 * start_inv_r9[[1]] - 
    fire_effect_r9 * start_inv_r9[[1]] -
    pest_effect_r9 * start_inv_r9[[1]] - 
      tornado_effect_r9 * start_inv_r9[[1]]
    
    # Define starting inventory value
    start_inv_r8 <- df$inventory.r8[df$year == (y-1)]
    
    # Calculate the new growth, removal, mortality percent of inventory for the year
    df$new_growth_pct_r8[df$year == y] <- (y - 2014)*growth_roc_r8 + growth_int_r8 
    #+ df$new_growth_pct_r8[df$year == (y-1)]*growth_lag_roc_r8
    df$new_mort_pct_r8[df$year == y] <- (y - 2014)*mortality_roc_r8 + mortality_int_r8 
    #+ df$new_mort_pct_r8[df$year == (y - 1)]*mortality_lag_roc_r8
    df$new_remv_pct_r8[df$year == y] <- (y - 2014)*removal_roc_r8 + removal_int_r8 
    #+ df$new_remv_pct_r8[df$year == (y-1)]*removal_lag_roc_r8

    if(df$new_growth_pct_r8 < 0){
      df$new_growth_pct_r8 <- 0
    }
    if(df$new_mort_pct_r8 < 0){
      df$new_mort_pct_r8 <- 0
    }
    if(df$new_remv_pct_r8 < 0){
      df$new_remv_pct_r8 <- 0
    }    
        
    # Calculate the inventory value for the year
    df$inventory.r8[df$year == y] <- start_inv_r8[[1]] + 
    df$new_growth_pct_r8[df$year == y] * start_inv_r8[[1]] - 
    df$new_mort_pct_r8[df$year == y] * start_inv_r8[[1]] - 
    df$new_remv_pct_r8[df$year == y] * start_inv_r8[[1]] - 
    fire_effect_r8 * start_inv_r8[[1]]-
    pest_effect_r8 * start_inv_r8[[1]] - 
      tornado_effect_r8 * start_inv_r8[[1]]
    
    # Define starting inventory value
    start_inv_r2 <- df$inventory.r2[df$year == (y-1)]
    
    # Calculate the new growth, removal, mortality percent of inventory for the year
    new_growth_pct_r2 <- (y - 2014)*growth_roc_r2 + growth_int_r2
    df$new_mort_pct_r2[df$year == y] <- (y - 2014)*mortality_roc_r2 + mortality_int_r2 
    #+ df$new_mort_pct_r2[df$year == (y-1)]*mortality_lag_roc_r2
    new_remv_pct_r2 <- (y - 2014)*removal_roc_r2 + removal_int_r2
    
    if(new_growth_pct_r2 < 0){
      new_growth_pct_r2 <- 0
    }
    if(df$new_mort_pct_r2[df$year == y] < 0){
      df$new_mort_pct_r2[df$year == y] <- 0
    }
    if(new_remv_pct_r2 < 0){
      new_remv_pct_r2 <- 0
    }    
    
    # Calculate the inventory value for the year
    df$inventory.r2[df$year == y] <- start_inv_r2[[1]] + 
    new_growth_pct_r2 * start_inv_r2[[1]] - 
    df$new_mort_pct_r2[df$year == y] * start_inv_r2[[1]] - 
    new_remv_pct_r2 * start_inv_r2[[1]] - 
    fire_effect_r2 * start_inv_r2[[1]] -  
    pest_effect_r2 * start_inv_r2[[1]] - 
      tornado_effect_r2 * start_inv_r2[[1]]
    
    y <- y+1
  }
  
  df$total_inventory = df$inventory.r9 + df$inventory.r8 + df$inventory.r2
  return(df$total_inventory)
}
```
```{r}
# This is where we define the number of times that we want the simulation to run
new_df <- tibble(years = years)
for (i in 2:500) {
  new_df[, i] <- run_sim()
}
```
```{r}
new_df_long <- new_df %>% gather(key = sim_number, value = value, - years)
```
```{r}
# Plot the results
ggplot(new_df_long, aes(x = years, y = value, colour = sim_number)) + 
  geom_smooth() +
  scale_y_continuous(limits = c(0, 85000000000)) +
  theme_minimal() +
  theme(legend.position = "none") +
  stat_summary(fun.y=mean, geom="line", colour="black", size = 2) +
  ggtitle("White Oak Forecast Simulation", subtitle = "The black line indicates the average forecasted value for each year.") +
  labs(y = "Inventory", x = "Year")
```


### Next Steps

Next we need to get a better understanding of the climate scenarios and how those may affect the growth/removal/mortality of the white oak population. Once we get an understanding of the effect, we can simulate the future population under each of these scenarios to get a more realistic prediction for white oak.

```{r echo = FALSE}

# simple_mod <- lm(total_inventory ~ growth.pct + remv.pct + mort.pct + total_acres, data = mod.dat.test)
# summary(simple_mod)
# 
# # multicollinearity
# vif(simple_mod)
# 
# # non constant variance
# ncvTest(simple_mod)
# 
# # independence of errors
# durbinWatsonTest(simple_mod)
# 
# 
# 
# simple_mod2 <- lm(total_inventory ~ total_growth + total_removal + total_mortality + total_acres, data = mod.dat.test)
# summary(simple_mod2)
# 
# vif(simple_mod2)
# ncvTest(simple_mod2)
# durbinWatsonTest(simple_mod2)

# Build linear models for each and save summary stats
growth.mod.r9 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r9)
growth.summary.r9 <- summary(growth.mod.r9)
mort.mod.r9 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r9)
mort.summary.r9 <- summary(mort.mod.r9)
remv.mod.r9 <- lm(log(remv.pct) ~ EVAL_GRP_YEAR, data = mod.dat.r9)
remv.summary.r9 <- summary(remv.mod.r9)

growth.mod.r8 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r8)
growth.summary.r8 <- summary(growth.mod.r8)
mort.mod.r8 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r8)
mort.summary.r8 <- summary(mort.mod.r8)
remv.mod.r8 <- lm(log(remv.pct) ~ EVAL_GRP_YEAR, data = mod.dat.r8)
remv.summary.r8 <- summary(remv.mod.r8)

growth.mod.r2 <- lm(growth.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
growth.summary.r2 <- summary(growth.mod.r2)
mort.mod.r2 <- lm(mort.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
mort.summary.r2 <- summary(mort.mod.r2)
remv.mod.r2 <- lm(remv.pct ~ EVAL_GRP_YEAR, data = mod.dat.r2)
remv.summary.r2 <- summary(remv.mod.r2)

library(lmtest)
par(mfrow = c(2, 2))
plot(remv.mod.r2)
shapiro.test(mod.dat.r2$remv.pct)
dwtest(remv.mod.r2)
library(gvlma)
summary(gvlma(remv.mod.r2))
# fail to reject the null
plot(remv.mod.r9)
dwtest(remv.mod.r9)
summary(gvlma(remv.mod.r9))
# fail to reject the null
plot(remv.mod.r8)
dwtest(remv.mod.r8)
summary(gvlma(remv.mod.r8))
##### REJECT THE NULL - how to deal with this?

dwtest(mort.mod.r2)
summary(gvlma(mort.mod.r2))
##### REJECT THE NULL - how to deal with this?
dwtest(mort.mod.r9)
summary(gvlma(mort.mod.r9))
# fail to reject the null
dwtest(mort.mod.r8)
summary(gvlma(mort.mod.r8))
##### REJECT THE NULL - how to deal with this?

dwtest(growth.mod.r2)
summary(gvlma(growth.mod.r2))
# fail to reject the null
dwtest(growth.mod.r9)
summary(gvlma(growth.mod.r9))
##### REJECT THE NULL - how to deal with this?
dwtest(growth.mod.r8)
summary(gvlma(mort.mod.r8))
##### REJECT THE NULL - how to deal with this?



mean(growth.mod.r9$residuals)
plot(fitted(growth.mod.r9), residuals(growth.mod.r9))


library(tseries)

ts_growth_r9 <- ts(mod.dat.r9$growth.pct, start = 2003, end = 2014)
ar_growth_r9 <- ar.ols(ts_growth_r9)


ggAcf(mod.dat.r9$growth.pct)
```